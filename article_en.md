
# Ultrasonic Emitter Positioning System Based on TDC7200 with Adaptive Logic and Threshold Control

## 📌 Abstract
Ultrasonic Testing (UT) is a widely used non-destructive testing method in industries, particularly for weld inspection and thickness measurement. A key limitation of traditional ultrasonic testing using an angled transducer, especially during manual scanning, is the absence of localization or precise positioning of the piezoelectric transducer (PET) in space. To address this, a PET positioning system architecture has been proposed, enabling the registration of its coordinates during each measurement.

---

## 📑 Table of Contents

1. [Introduction](#1-introduction)
2. [Microcontroller and System Architecture](#2-microcontroller-and-system-architecture)
3. [TDC7200 Operating Mode and Measurement Range](#3-tdc7200-operating-mode-and-measurement-range)  
4. [Working with Ultrasonic Pulse Packets](#4-working-with-ultrasonic-pulse-packets)  
5. [Data Storage and Analysis from TDC7200 (on Arduino Due)](#5-data-storage-and-analysis-from-tdc7200-on-arduino-due)
6. [Determining the Speed of Sound in Air](#6-determining-the-speed-of-sound-in-air)
7. [Applications in Inspection and Positioning](#7-applications-in-inspection-and-positioning)  
8. [Algorithms and Logic](#8-algorithms-and-logic)  
9. [System Advantages](#9-system-advantages)  
10. [Limitations and Operational Features](#10-limitations-and-operational-features)  
11. [Conclusion](#11-conclusion)   
    [Related Materials](#related-materials)   
    [Author](#author)  

---

## 1. Introduction

Positioning the ultrasonic piezoelectric transducer (PET)—a key element of non-destructive metal testing—is critical for weld inspection and other tasks where it is essential to distinguish real defects from false reflections. These PETs typically operate in the **1–15 MHz** range and are used for thickness measurement, defect detection, and other testing purposes.

However, during manual scanning on flat or especially curved surfaces, the spatial position of the PET remains unknown, complicating result interpretation. To resolve this issue, an auxiliary **PET positioning system** has been developed, based on registering ultrasonic pulses in the **40 kHz** range.

The system consists of a miniature **40 kHz transmitter** (e.g., MA40S4S) attached to the PET housing and **several 40 kHz receivers** (e.g., MA40S4R) located outside the control zone. During each measurement, the primary system simultaneously generates a burst of signals from the transmitter. Using the time-of-flight to the receivers and the known speed of sound in air, the system calculates the PET coordinates.

The hardware is built around the **TDC7200** chip, which offers time interval measurement resolution down to **55 ps**, enabling high-precision delay measurements between START and STOP signals.  
Source: [TI TDC7200 Datasheet](https://www.ti.com/lit/gpn/TDC7200)

To extend capabilities, **Mode 2** is used, supporting measurements up to **8 ms**, corresponding to distances up to ~2.7 m in air (depending on temperature and humidity).

The first `START` pulse is generated by the microcontroller (**Arduino Due**), and subsequent pulses are generated **hardware-based**—using the `INTB` signal triggered at the end of each measurement cycle. This signal passes through an **inverter** and a **logical AND gate**, then merges via an **OR gate** with the controller’s control signal.

> This logic eliminates software delays and achieves measurement frequencies of up to 16–20 kHz.

A comparator determines the signal arrival moment, featuring an **adaptive threshold** adjustable via the controller’s `DAC`. The threshold adapts to conditions, such as the number of received pulses and intervals between them.

Intervals between 40 kHz pulses are ~25 µs. If a gap exceeding 50 µs is detected between `STOP` signals, the measurement is considered complete.

The system also integrates a digital **temperature and humidity sensor** (e.g., **SHT31**) via the I²C interface, accounting for the influence of atmospheric conditions on the speed of sound.

> The speed of sound in air depends on both temperature and humidity, affecting positioning accuracy.

It is noteworthy that the **TRIGG output** of TDC7200 is **not used** in this architecture. All cycles are controlled via `START` and `INTB`, and Mode 2 eliminates additional timing constraints associated with TRIGG.

![Group 4](https://github.com/user-attachments/assets/4114279d-b7cd-4225-9f93-b09ea78f0ebb)
*Fig. 1: Control Architecture: Connections between Arduino Due, TDC7200, Comparator, Logic, Temperature/Humidity Sensor, and 40 kHz Ultrasonic Sensors*

---

## 2. Microcontroller and System Architecture

The system’s central control is performed by the **Arduino Due** microcontroller, chosen for its high clock speed, integrated DAC, sufficient number of digital outputs, and convenient SPI and I²C interface handling.

### 🔁 Overall Structure

The complete architecture encompasses the entire signal path—from ultrasonic generation to reception and precise time-of-flight measurement:

```text
Arduino DUE → MOSFET → Transmitter → Air → Receiver
→ Amplifier → Comparator → TDC7200 → SPI → Arduino DUE
